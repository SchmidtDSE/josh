# @category: types
# @subcategory: distributions
# @priority: high
# @description: Test multiple reduction operations in same expression and simulation

start simulation DistributionsMultipleReductions

  grid.size = 10 m
  grid.low.x = 0 m
  grid.low.y = 0 m
  grid.high.x = 100 m
  grid.high.y = 100 m  # 10x10 grid

  steps.low = 0 count
  steps.high = 1 count

  stepCount.init = 0 count
  stepCount.step = prior.stepCount + 1 count

end simulation

start patch Default

  # Create organisms with known values
  Trees.init = create 5 count of Tree

  # Test multiple reductions on same collection
  # Trees have ages: 10, 20, 30, 40, 50 years
  treeMean.init = mean(Trees.age)
  treeStd.init = std(Trees.age)
  treeMin.init = min(Trees.age)
  treeMax.init = max(Trees.age)
  treeSum.init = sum(Trees.age)
  treeCount.init = count(Trees)

  # Assert all reductions work correctly together
  assert.mean.init = treeMean == 30 years
  assert.min.init = treeMin == 10 years
  assert.max.init = treeMax == 50 years
  assert.sum.init = treeSum == 150 years
  assert.count.init = treeCount == 5 count

  # Assert std is in reasonable range
  assert.stdRange.init = treeStd > 10 years
  assert.stdRange2.init = treeStd < 20 years

  # Test multiple reductions on stochastic collection
  Plants.init = create 100 count of Plant

  # Heights from uniform(0, 100)
  plantMean.init = mean(Plants.height)
  plantStd.init = std(Plants.height)
  plantMin.init = min(Plants.height)
  plantMax.init = max(Plants.height)
  plantSum.init = sum(Plants.height)
  plantCount.init = count(Plants)

  # Assert count is correct
  assert.plantCount.init = plantCount == 100 count

  # Assert mean is reasonable (expected ~50)
  assert.plantMean.init = plantMean > 45 m
  assert.plantMean2.init = plantMean < 55 m

  # Assert std is reasonable (expected ~28.87)
  assert.plantStd.init = plantStd > 23 m
  assert.plantStd2.init = plantStd < 35 m

  # Assert min is near 0
  assert.plantMin.init = plantMin < 5 m

  # Assert max is near 100
  assert.plantMax.init = plantMax > 95 m

  # Assert sum is reasonable (expected ~5000 = 100 * 50)
  assert.plantSum.init = plantSum > 4500 m
  assert.plantSum2.init = plantSum < 5500 m

  # Test relationships between reductions
  # mean * count should approximately equal sum
  expectedSum.init = plantMean * plantCount
  sumDiff.init = expectedSum - plantSum

  # Difference should be close to 0 (within floating point precision)
  assert.sumMeanRelation.init = sumDiff > -1 m
  assert.sumMeanRelation2.init = sumDiff < 1 m

end patch

start organism Tree

  # Assign deterministic ages based on creation order
  age.init = 10 years * (current.meta.index + 1)
  age.step = prior.age

end organism

start organism Plant

  # Stochastic height from uniform distribution
  height.init = sample uniform from 0 m to 100 m
  height.step = prior.height

end organism

start unit m
  alias meter
  alias meters
end unit

start unit years
  alias year
  alias yr
  alias yrs
end unit
