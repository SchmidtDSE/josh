# @category: core
# @subcategory: collections
# @priority: high
# @description: Test chained collection operations combining filter, combine, and remove

start simulation CollectionsChained

  grid.size = 10 m
  grid.low = 36.0 degrees latitude, -118.0 degrees longitude
  grid.high = 36.01 degrees latitude, -117.99 degrees longitude

  steps.low = 0 count
  steps.high = 8 count

  stepCount.init = 0 count
  stepCount.step = prior.stepCount + 1 count

end simulation

start patch Default

  # Create multiple organism types
  Oaks.init = create 10 count of Oak
  Pines.init = create 10 count of Pine
  Firs.init = create 10 count of Fir

  # Chain 1: Combine then filter
  # Combine all conifers, then filter by age
  allConifers.step:if(meta.stepCount >= 1 count) = combine(Pines, Firs)
  oldConifers.step:if(meta.stepCount >= 2 count) = allConifers[Pine.age > 5 years or Fir.age > 5 years]

  # Chain 2: Filter then combine
  # Filter each type, then combine the filtered results
  oldOaks.step:if(meta.stepCount >= 2 count) = Oaks[Oak.age > 5 years]
  oldPines.step:if(meta.stepCount >= 2 count) = Pines[Pine.age > 5 years]
  oldTrees.step:if(meta.stepCount >= 2 count) = combine(oldOaks, oldPines)

  # Chain 3: Filter, combine, then filter again
  # Get tall trees from each type, combine them, then filter by age
  tallOaks.step:if(meta.stepCount >= 2 count) = Oaks[Oak.height > 3 m]
  tallPines.step:if(meta.stepCount >= 2 count) = Pines[Pine.height > 4 m]
  allTall.step:if(meta.stepCount >= 2 count) = combine(tallOaks, tallPines)
  tallAndOld.step:if(meta.stepCount >= 2 count) = allTall[Oak.age > 5 years or Pine.age > 5 years]

  # Chain 4: Complex realistic scenario
  # Find mature trees (age >= 5), combine them, remove young ones from overall population
  matureOaks.step:if(meta.stepCount >= 3 count) = Oaks[Oak.age >= 5 years]
  maturePines.step:if(meta.stepCount >= 3 count) = Pines[Pine.age >= 5 years]
  matureFirs.step:if(meta.stepCount >= 3 count) = Firs[Fir.age >= 5 years]
  allMature.step:if(meta.stepCount >= 3 count) = combine(matureOaks, maturePines, matureFirs)

  # Remove young trees at step 4 (simulate thinning young growth)
  youngOaks.step:if(meta.stepCount == 4 count) = Oaks[Oak.age < 3 years]
  youngPines.step:if(meta.stepCount == 4 count) = Pines[Pine.age < 3 years]
  removeYoungOaks.step:if(meta.stepCount == 4 count) = youngOaks
  removeYoungPines.step:if(meta.stepCount == 4 count) = youngPines

  # Chain 5: Filter combined collection, then combine with another filtered collection
  moderateAgeOaks.step:if(meta.stepCount >= 5 count) = Oaks[(Oak.age >= 3 years) and (Oak.age <= 7 years)]
  moderateAgePines.step:if(meta.stepCount >= 5 count) = Pines[(Pine.age >= 3 years) and (Pine.age <= 7 years)]
  allModerateAge.step:if(meta.stepCount >= 5 count) = combine(moderateAgeOaks, moderateAgePines)
  tallFirs.step:if(meta.stepCount >= 5 count) = Firs[Fir.height > 4 m]
  moderateAgeOrTallFir.step:if(meta.stepCount >= 5 count) = combine(allModerateAge, tallFirs)

  # Assert initial collection sizes
  assert.oaksCountInit.step:if(meta.stepCount == 1 count) = count(Oaks) == 10 count
  assert.pinesCountInit.step:if(meta.stepCount == 1 count) = count(Pines) == 10 count
  assert.firsCountInit.step:if(meta.stepCount == 1 count) = count(Firs) == 10 count

  # Assert Chain 1: Combine then filter
  assert.allConifersSize.step:if(meta.stepCount == 2 count) = count(allConifers) == 20 count
  # Old conifers (age > 5): Pines indices 6-9 + Firs indices 6-9 = 8 trees
  assert.oldConifersSize.step:if(meta.stepCount == 2 count) = count(oldConifers) == 8 count

  # Assert Chain 2: Filter then combine
  # Old oaks (age > 5): indices 6-9 = 4 trees
  # Old pines (age > 5): indices 6-9 = 4 trees
  assert.oldOaksSize.step:if(meta.stepCount == 2 count) = count(oldOaks) == 4 count
  assert.oldPinesSize.step:if(meta.stepCount == 2 count) = count(oldPines) == 4 count
  assert.oldTreesSize.step:if(meta.stepCount == 2 count) = count(oldTrees) == 8 count

  # Assert Chain 3: Filter, combine, filter
  # Tall oaks (height > 3m): oaks start at 2m + index*0.3m + 0.3m growth = 2.3-5.0m, indices 3-9 are tall
  # Tall pines (height > 4m): pines start at 3m + index*0.4m + 0.4m growth = 3.4-7.0m, indices 3-9 are tall
  assert.tallOaksSize.step:if(meta.stepCount == 2 count) = count(tallOaks) == 7 count
  assert.tallPinesSize.step:if(meta.stepCount == 2 count) = count(tallPines) == 7 count
  assert.allTallSize.step:if(meta.stepCount == 2 count) = count(allTall) == 14 count
  # Tall and old (from allTall, age > 5): indices 6-9 from both = 8 trees
  assert.tallAndOldSize.step:if(meta.stepCount == 2 count) = count(tallAndOld) == 8 count

  # Assert Chain 4: Complex realistic scenario
  # Mature (age >= 5): indices 5-9 from each type = 5 * 3 = 15 trees
  assert.allMatureSize.step:if(meta.stepCount == 3 count) = count(allMature) == 15 count

  # After removal at step 4, young trees (age < 3) removed
  # Young oaks and pines removed: indices 0-2 from each = 6 total removed
  assert.oaksAfterRemoval.step:if(meta.stepCount == 5 count) = count(Oaks) == 7 count
  assert.pinesAfterRemoval.step:if(meta.stepCount == 5 count) = count(Pines) == 7 count
  assert.firsAfterRemoval.step:if(meta.stepCount == 5 count) = count(Firs) == 10 count

  # Assert Chain 5: Complex filtering and combining
  # Moderate age (3 <= age <= 7): after removal, remaining oaks/pines are indices 3-9
  # At step 5, these have ages 8-14, so age range 3-7 doesn't match any at step 5
  # But step-by-step: at step 5, ages are original_index + 4
  # So we need indices where 3 <= (index + 4) <= 7, meaning -1 <= index <= 3
  # After removal (indices 0-2 gone), indices 3 has age 7, so 1 oak + 1 pine
  assert.moderateAgeOaksSize.step:if(meta.stepCount == 5 count) = count(moderateAgeOaks) == 1 count
  assert.moderateAgePinesSize.step:if(meta.stepCount == 5 count) = count(moderateAgePines) == 1 count
  assert.allModerateAgeSize.step:if(meta.stepCount == 5 count) = count(allModerateAge) == 2 count

  # Tall firs (height > 4m): firs start at 2.5m + index*0.35m, at step 5 have grown 4*0.35m
  # Heights at step 5: 2.5 + 1.4 + index*0.35 = 3.9-7.05m, indices 1-9 are tall
  assert.tallFirsSize.step:if(meta.stepCount == 5 count) = count(tallFirs) == 9 count
  assert.moderateAgeOrTallFirSize.step:if(meta.stepCount == 5 count) = count(moderateAgeOrTallFir) == 11 count

  # Assert chained operations produce different results than individual operations
  assert.chainedDifferent.step:if(meta.stepCount == 2 count) = count(oldConifers) != count(allConifers)
  assert.filterOrderMatters.step:if(meta.stepCount == 2 count) = count(tallAndOld) != count(allTall)

  # Test temporal stability: chained results should remain stable when inputs don't change
  oldConifersLater.step:if(meta.stepCount == 3 count) = allConifers[Pine.age > 6 years or Fir.age > 6 years]
  assert.oldConifersLaterSize.step:if(meta.stepCount == 3 count) = count(oldConifersLater) == 8 count

end patch

start organism Oak

  age.init = index
  age.step = prior.age + 1 year

  height.init = 2 m + (index * 0.3 m)
  height.step = prior.height + 0.3 m

  # Assert individual oak ages correctly
  assert.oakAgeStep3.step:if(meta.stepCount == 3 count and index == 7) = current.age == 10 years

end organism

start organism Pine

  age.init = index
  age.step = prior.age + 1 year

  height.init = 3 m + (index * 0.4 m)
  height.step = prior.height + 0.4 m

  # Assert individual pine ages correctly
  assert.pineAgeStep3.step:if(meta.stepCount == 3 count and index == 8) = current.age == 11 years

end organism

start organism Fir

  age.init = index
  age.step = prior.age + 1 year

  height.init = 2.5 m + (index * 0.35 m)
  height.step = prior.height + 0.35 m

  # Assert individual fir ages correctly
  assert.firAgeStep3.step:if(meta.stepCount == 3 count and index == 6) = current.age == 9 years

end organism

start unit year
  alias years
  alias yr
  alias yrs
end unit

start unit m
  alias meter
  alias meters
end unit
