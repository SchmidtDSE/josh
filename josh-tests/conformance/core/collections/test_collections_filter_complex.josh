# @category: core
# @subcategory: collections
# @priority: high
# @description: Test filtering collections with multiple conditions using AND, OR, NOT operators

start simulation CollectionsFilterComplex

  grid.size = 10 m
  grid.low = 36.0 degrees latitude, -118.0 degrees longitude
  grid.high = 36.01 degrees latitude, -117.99 degrees longitude

  steps.low = 0 count
  steps.high = 5 count

  stepCount.init = 0 count
  stepCount.step = prior.stepCount + 1 count

end simulation

start patch Default

  # Create trees with varying characteristics
  Trees.init = create 30 count of Tree

  # Complex filter with AND operator
  # Old AND tall trees
  oldAndTall.step:if(meta.stepCount >= 2 count) = Trees[(Tree.age > 10 years) and (Tree.height > 5 m)]

  # Complex filter with OR operator
  # Young OR short trees
  youngOrShort.step:if(meta.stepCount >= 2 count) = Trees[(Tree.age < 5 years) or (Tree.height < 3 m)]

  # Complex filter with NOT operator (using !=)
  # Not mature trees (status != 1)
  notMature.step:if(meta.stepCount >= 2 count) = Trees[Tree.status != 1 count]

  # Nested conditions with AND and OR
  # (Old and tall) OR (young and growing)
  complexMix.step:if(meta.stepCount >= 2 count) = Trees[((Tree.age > 15 years) and (Tree.height > 8 m)) or ((Tree.age < 5 years) and (Tree.height > 2 m))]

  # Multiple AND conditions
  # Age between 5 and 15 years (age > 5 AND age < 15)
  midAge.step:if(meta.stepCount >= 2 count) = Trees[(Tree.age > 5 years) and (Tree.age < 15 years)]

  # Multiple OR conditions
  # Very young or very old (age < 3 OR age > 20)
  extremeAge.step:if(meta.stepCount >= 2 count) = Trees[(Tree.age < 3 years) or (Tree.age > 20 years)]

  # Complex three-way condition
  # Tall AND (old OR mature)
  tallAndOldOrMature.step:if(meta.stepCount >= 2 count) = Trees[(Tree.height > 5 m) and ((Tree.age > 10 years) or (Tree.status == 1 count))]

  # Assert total tree count remains constant
  assert.totalTrees.step:if(meta.stepCount == 2 count) = count(Trees) == 30 count

  # Assert AND filter results
  # After step 2, trees have ages 1-30 and heights 1.5-15.5m (each tree index*0.5m + 1m base + 0.5m growth)
  # Old (>10) AND tall (>5m): trees with index 11+ have both age>10 and height>5m
  assert.oldAndTallCount.step:if(meta.stepCount == 2 count) = count(oldAndTall) == 19 count

  # Assert OR filter results
  # Young (<5) OR short (<3m): indices 0-4 are young, indices 0-2 are short (at step 2)
  assert.youngOrShortCount.step:if(meta.stepCount == 2 count) = count(youngOrShort) == 5 count

  # Assert NOT filter (status != 1 means age < 10 at step 2)
  assert.notMatureCount.step:if(meta.stepCount == 2 count) = count(notMature) == 10 count

  # Assert mid-age range filter (5 < age < 15)
  # Trees with indices 6-14 fall in this range
  assert.midAgeCount.step:if(meta.stepCount == 2 count) = count(midAge) == 9 count

  # Assert extreme age filter (age < 3 OR age > 20)
  # Indices 0-2 (age < 3) + indices 21-29 (age > 20) = 12 trees
  assert.extremeAgeCount.step:if(meta.stepCount == 2 count) = count(extremeAge) == 12 count

  # Assert complex three-way condition
  # Tall (>5m) AND (old (>10) OR mature (status==1))
  # Since status==1 when age>=10, this is effectively tall AND age>=10
  assert.tallAndOldOrMatureCount.step:if(meta.stepCount == 2 count) = count(tallAndOldOrMature) == 20 count

  # Test that complex filters change over time
  oldAndTallStep3.step:if(meta.stepCount == 3 count) = Trees[(Tree.age > 10 years) and (Tree.height > 5 m)]
  assert.oldAndTallGrows.step:if(meta.stepCount == 3 count) = count(oldAndTallStep3) == 20 count

  # Test edge case: contradictory conditions (no matches)
  impossible.step:if(meta.stepCount == 2 count) = Trees[(Tree.age < 1 year) and (Tree.age > 50 years)]
  assert.impossibleEmpty.step:if(meta.stepCount == 2 count) = count(impossible) == 0 count

  # Test filter that matches all trees
  allMatch.step:if(meta.stepCount == 2 count) = Trees[(Tree.age >= 0 years) or (Tree.age < 0 years)]
  assert.allMatchFull.step:if(meta.stepCount == 2 count) = count(allMatch) == 30 count

end patch

start organism Tree

  # Each tree starts with an incrementing age (0, 1, 2, ... 29)
  age.init = index
  age.step = prior.age + 1 year

  # Height starts at 1m + index*0.5m and grows 0.5m per year
  height.init = 1 m + (index * 0.5 m)
  height.step = prior.height + 0.5 m

  # Status flag: 1 for trees >= 10 years old
  status.init = 0 count
  status.step:if(current.age >= 10 years) = 1 count
  status.step:if(current.age < 10 years) = 0 count

  # Assert individual tree properties
  assert.statusSetCorrectly.step:if(meta.stepCount == 2 count and index == 15) = current.status == 1 count
  assert.statusNotSetYoung.step:if(meta.stepCount == 2 count and index == 5) = current.status == 0 count

end organism

start unit year
  alias years
  alias yr
  alias yrs
end unit

start unit m
  alias meter
  alias meters
end unit
