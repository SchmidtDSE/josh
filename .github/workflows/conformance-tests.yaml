name: Conformance Tests

on:
  push:
    branches: [ main, dev, 'feat/**' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  conformance:
    runs-on: ubuntu-latest
    name: Josh Conformance Test Suite

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Update apt
        run: sudo apt-get update

      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev

      - name: Generate external test data
        run: ./gradlew generateTestData

      - name: Run conformance tests
        id: conformance_tests
        continue-on-error: true  # Don't fail the job, we'll handle it below
        run: |
          ./gradlew test --tests "org.joshsim.conformance.JoshConformanceTest" \
            --no-daemon \
            2>&1 | tee conformance_test_output.txt

      - name: Parse test results
        id: parse_results
        if: always()
        run: |
          # Extract test counts from gradle output
          TOTAL=$(find build/test-results/test -name "*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          FAILED=$(find build/test-results/test -name "*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          ERRORS=$(find build/test-results/test -name "*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')

          # Calculate passed
          PASSED=$((TOTAL - FAILED - ERRORS))

          # Calculate percentage
          if [ "$TOTAL" -gt 0 ]; then
            PERCENT=$((PASSED * 100 / TOTAL))
          else
            PERCENT=0
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$((FAILED + ERRORS))" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

          # Create summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üß™ Conformance Test Results

          | Metric | Value |
          |--------|-------|
          | **Total Tests** | $TOTAL |
          | **‚úÖ Passed** | $PASSED ($PERCENT%) |
          | **‚ùå Failed** | $((FAILED + ERRORS)) |

          EOF

          # Add failing test details if any
          if [ "$((FAILED + ERRORS))" -gt 0 ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### Failed Tests

          See the [test report artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          EOF
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-test-results
          path: |
            build/test-results/test/*.xml
            build/reports/tests/test/
            conformance_test_output.txt
            TEST_SUITE_STATUS.md
            .claude/tasks/*.md
          retention-days: 30

      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Conformance Test Report
          path: 'build/test-results/test/*.xml'
          reporter: java-junit
          fail-on-error: false  # Don't fail the workflow

      - name: Create test badge data
        if: always()
        run: |
          PASSED=${{ steps.parse_results.outputs.passed }}
          TOTAL=${{ steps.parse_results.outputs.total }}
          PERCENT=${{ steps.parse_results.outputs.percent }}

          # Determine badge color
          if [ "$PERCENT" -ge 90 ]; then
            COLOR="brightgreen"
          elif [ "$PERCENT" -ge 75 ]; then
            COLOR="green"
          elif [ "$PERCENT" -ge 50 ]; then
            COLOR="yellow"
          elif [ "$PERCENT" -ge 25 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          # Create badge JSON
          mkdir -p badges
          cat > badges/conformance.json << EOF
          {
            "schemaVersion": 1,
            "label": "conformance",
            "message": "$PASSED/$TOTAL ($PERCENT%)",
            "color": "$COLOR"
          }
          EOF

      - name: Upload badge data
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        uses: actions/upload-artifact@v4
        with:
          name: conformance-badge
          path: badges/conformance.json

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const passed = ${{ steps.parse_results.outputs.passed }};
            const failed = ${{ steps.parse_results.outputs.failed }};
            const total = ${{ steps.parse_results.outputs.total }};
            const percent = ${{ steps.parse_results.outputs.percent }};

            const emoji = percent >= 90 ? 'üéâ' : percent >= 75 ? '‚úÖ' : percent >= 50 ? '‚ö†Ô∏è' : '‚ùå';

            const body = `## ${emoji} Conformance Test Results

            | Metric | Value |
            |--------|-------|
            | **Total Tests** | ${total} |
            | **Passed** | ${passed} (${percent}%) |
            | **Failed** | ${failed} |

            ${failed > 0 ? '### ‚ö†Ô∏è Some tests are failing\n\nSee the [detailed test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more information.' : '### üéâ All conformance tests passing!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set job status
        if: always()
        run: |
          FAILED=${{ steps.parse_results.outputs.failed }}
          if [ "$FAILED" -gt 0 ]; then
            echo "::warning::$FAILED conformance tests failed"
            # Don't exit 1 - we want this to be informational, not blocking
          else
            echo "::notice::All conformance tests passed!"
          fi
