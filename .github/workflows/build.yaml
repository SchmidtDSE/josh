name: Build
on: [push]

jobs:
  buildSpec:
    environment: Build
    runs-on: ubuntu-latest
    name: Build Paper
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Update apt
        run: sudo apt-get update
      - name: Install LaTeX
        run: sudo apt-get install texlive-extra-utils texlive-fonts-recommended texlive-latex-base texlive-latex-extra
      - name: Get Pandoc
        run: wget https://github.com/jgm/pandoc/releases/download/3.1.10/pandoc-3.1.10-1-amd64.deb
      - name: Install Pandoc
        run: sudo dpkg -i pandoc-3.1.10-1-amd64.deb
      - name: Build paper
        run: pandoc -o spec.pdf --number-sections LanguageSpecification.md
      - name: Upload paper
        uses: actions/upload-artifact@v4
        with:
          name: spec
          path: spec.pdf
  buildJava:
    environment: Build
    runs-on: ubuntu-latest
    name: Build Fat Jar
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Build fat jar
        run: ./gradlew fatJar
      - name: Upload jar
        uses: actions/upload-artifact@v4
        with:
          name: fatJar
          path: build/libs/joshsim-fat.jar
  checkJava:
    needs: buildJava
    environment: Build
    runs-on: ubuntu-latest
    name: Static Checks
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Check grammar
        run: ./gradlew generateGrammarSource
      - name: Check main style
        run: ./gradlew checkstyleMain
      - name: Check test style
        run: ./gradlew checkstyleTest
  checkPython:
    environment: Build
    runs-on: ubuntu-latest
    name: Python Checks
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Test install
        run: cd joshpy; pip install .
      - name: Install optional
        run: cd joshpy; pip install .[dev]
      - name: Run pyflakes
        run: pyflakes joshpy/joshpy/*.py
      - name: Run tests
        run: cd joshpy && nose2
  testJava:
    needs: buildJava
    environment: Build
    runs-on: ubuntu-latest
    name: Test Java
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Update apt
        run: sudo apt-get update
      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Run tests
        run: ./gradlew test
  testPreprocessing:
    needs: buildJava
    environment: Build
    runs-on: ubuntu-latest
    name: Test Preprocessing and Create Tutorial Data
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Update apt
        run: sudo apt-get update
      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev
      - name: Download fat jar
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Setup environment
        run: |
          mkdir -p build/libs
          mv joshsim-fat.jar build/libs/
          chmod +x examples/test_basic_preprocess.sh
          chmod +x examples/test_spatial_preprocess.sh
          chmod +x landing/test_preprocess.sh
      - name: Run basic preprocessing tests
        run: bash examples/test_basic_preprocess.sh
      - name: Run spatial preprocessing tests
        run: bash examples/test_spatial_preprocess.sh
      - name: Run temporal preprocessing and create tutorial data
        run: bash landing/test_preprocess.sh
      - name: Upload preprocessed tutorial data
        uses: actions/upload-artifact@v4
        with:
          name: preprocessed-tutorial-data
          path: landing/preprocessed_data/
  validateExamples:
    needs: buildJava
    environment: Build
    runs-on: ubuntu-latest
    name: Validate Josh examples
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Validate examples
        run: bash examples/validate.sh
  testOutputFormatCSV:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test CSV Output Format
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Test CSV output
        run: |
          echo "Testing CSV output..."
          rm -f /tmp/simple_josh.csv
          java -Xmx6g -jar build/libs/joshsim-fat.jar run --replicates=1 examples/simulations/simple.josh TestSimpleSimulation || exit 1
          [ -f "/tmp/simple_josh.csv" ] || exit 2
          [ -s "/tmp/simple_josh.csv" ] || exit 3
          echo "Testing CSV with Earth-space output..."
          rm -f /tmp/simple_seki_josh.csv
          java -Xmx6g -jar build/libs/joshsim-fat.jar run --replicates=2 examples/simulations/simple_seki.josh TestSimpleSimulation || exit 4
          [ -f "/tmp/simple_seki_josh.csv" ] || exit 5
          [ -s "/tmp/simple_seki_josh.csv" ] || exit 6
          echo "✓ CSV output format tests passed!"
  testOutputFormatNetCDF:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test NetCDF Output Format
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Update apt
        run: sudo apt-get update
      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Test netCDF output
        run: |
          echo "Testing netCDF output..."
          rm -f /tmp/simple_josh_*.nc
          java -Xmx6g -jar build/libs/joshsim-fat.jar run --replicates=2 examples/simulations/simple_netcdf.josh TestSimpleSimulation || exit 7
          [ -f "/tmp/simple_josh_0.nc" ] || exit 8
          [ -f "/tmp/simple_josh_1.nc" ] || exit 9
          [ -s "/tmp/simple_josh_0.nc" ] || exit 10
          [ -s "/tmp/simple_josh_1.nc" ] || exit 11
          echo "✓ NetCDF output format tests passed!"
  testOutputFormatGeoTIFF:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test GeoTIFF Output Format
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Test geotiff output
        run: |
          echo "Testing geotiff output..."
          rm -f /tmp/simple_josh_*.tiff
          java -Xmx6g -jar build/libs/joshsim-fat.jar run --replicates=2 examples/simulations/simple_geotiff.josh TestSimpleSimulation || exit 12
          [ -f "/tmp/simple_josh_averageAge_0_0.tiff" ] || exit 13
          [ -s "/tmp/simple_josh_averageAge_0_0.tiff" ] || exit 14
          [ -f "/tmp/simple_josh_averageHeight_1_1.tiff" ] || exit 15
          [ -s "/tmp/simple_josh_averageHeight_1_1.tiff" ] || exit 16
          echo "✓ GeoTIFF output format tests passed!"
  testGuideExamples:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test Guide Examples
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Update apt
        run: sudo apt-get update
      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Download preprocessed tutorial data
        uses: actions/download-artifact@v4
        with:
          name: preprocessed-tutorial-data
          path: ./landing/preprocessed_data/
      - name: Test guide examples
        run: bash examples/test_guide_examples.sh
  testConfiguration:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test Configuration Features
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Test configuration
        run: bash examples/test_config.sh
  testAdditionalFeatures:
    needs: [validateExamples, testPreprocessing]
    environment: Build
    runs-on: ubuntu-latest
    name: Test Additional Features
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Update apt
        run: sudo apt-get update
      - name: Setup netCDF
        run: sudo apt-get install -y libnetcdf-dev
      - name: Download farJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fatJar
      - name: Move artifact
        run: mkdir -p build/libs; mv joshsim-fat.jar build/libs/joshsim-fat.jar
      - name: Download preprocessed tutorial data
        uses: actions/download-artifact@v4
        with:
          name: preprocessed-tutorial-data
          path: ./landing/preprocessed_data/
      - name: Test external data with --data option
        run: bash examples/test_data_option.sh
      - name: Test job configuration template functionality
        run: bash examples/test_job_config.sh
  buildWeb:
    environment: Build
    needs: [ checkJava, buildJava, testJava, validateExamples, testOutputFormatCSV, testOutputFormatNetCDF, testOutputFormatGeoTIFF, testGuideExamples, testConfiguration, testAdditionalFeatures, testPreprocessing ]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    name: Build for Browser
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Build war
        run: ./gradlew war
      - name: Update apt
        run: sudo apt-get update
      - name: Install wget
        run: sudo apt-get install -y wget
      - name: Load JS deps
        run: cd editor/third_party; bash install_deps.sh
      - name: Install landing deps
        run: cd landing; bash install_deps.sh
      - name: Optimize publicsans deployment
        run: |
          # Optimize landing fonts
          cd landing
          if [ -d "publicsans/fonts/otf" ]; then
            mkdir -p publicsans-minimal/fonts/otf
            cp publicsans/fonts/otf/PublicSans-Regular.otf publicsans-minimal/fonts/otf/
            rm -rf publicsans
            mv publicsans-minimal publicsans
          fi
          cd ..
          # Optimize editor fonts
          cd editor/third_party
          if [ -d "publicsans/fonts/otf" ]; then
            mkdir -p publicsans-minimal/fonts/otf
            cp publicsans/fonts/otf/PublicSans-Regular.otf publicsans-minimal/fonts/otf/
            rm -rf publicsans
            mv publicsans-minimal publicsans
          fi
      - name: Copy guide examples to landing
        run: |
          mkdir -p landing/examples/guide
          cp examples/guide/hello.josh landing/examples/guide/
          cp examples/guide/grass_shrub_fire.josh landing/examples/guide/
          cp examples/guide/two_trees.josh landing/examples/guide/
      - name: Upload war
        uses: actions/upload-artifact@v4
        with:
          name: war
          path: build/libs/JoshSim.war
      - name: Embed war
        run: bash editor/war/get_from_jar.sh
      - name: Build fat jar
        run: ./gradlew fatJar
      - name: Upload full jar
        uses: actions/upload-artifact@v4
        with:
          name: fullJar
          path: build/libs/joshsim-fat.jar
      - name: Upload editor
        uses: actions/upload-artifact@v4
        with:
          name: editor
          path: editor
      - name: Upload landing
        uses: actions/upload-artifact@v4
        with:
          name: landing
          path: landing
  deployStatic:
    environment: Deploy
    runs-on: ubuntu-latest
    name: Deploy to SFTP
    needs: [buildWeb, testPreprocessing]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    steps:
      - name: Set environment variables based on branch
        run: |
          if [[ $GITHUB_REF == refs/heads/main ]]; then
            echo "EDITOR_DIRECTORY=editor.joshsim.org" >> $GITHUB_ENV
            echo "LANDING_DIRECTORY=joshsim.org" >> $GITHUB_ENV
            echo "Deploying to production environment"
          else
            echo "EDITOR_DIRECTORY=editor.joshsim.org/dev" >> $GITHUB_ENV
            echo "LANDING_DIRECTORY=joshsim.org/dev" >> $GITHUB_ENV
            echo "Deploying to directory environment"
          fi
      - name: Set branch name
        id: branch
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
      - name: Download fatJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fullJar
          path: ./deploy
      - name: Download WAR artifact
        uses: actions/download-artifact@v4
        with:
          name: war
          path: ./deploy/war
      - name: Download preprocessed tutorial data
        uses: actions/download-artifact@v4
        with:
          name: preprocessed-tutorial-data
          path: ./tutorial-data-temp
      - name: Install SSH client and sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client sshpass
      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p 22 ${{ secrets.SFTPHOST }} >> ~/.ssh/known_hosts
      - name: Upload Jar via SCP
        env:
          SSHPASS: ${{ secrets.SFTPPASSWORD }}
        run: |
          sshpass -e scp -r -P 22 -o StrictHostKeyChecking=no \
            ./deploy/* \
            ${{ secrets.SFTPUSER }}@${{ secrets.SFTPHOST }}:./joshsim.org/dist/${{ steps.branch.outputs.name }}/
      - name: Download editor
        uses: actions/download-artifact@v4
        with:
          name: editor
          path: ./editor-build
      - name: Checkout for llms.txt
        uses: actions/checkout@v3
        with:
          path: ./repo
      - name: Copy documentation files to editor
        run: |
          cp ./repo/llms.txt ./editor-build/
          cp ./repo/llms-full.txt ./editor-build/
          cp -r ./repo/docs ./editor-build/docs
      - name: Upload Editor via SCP
        env:
          SSHPASS: ${{ secrets.SFTPPASSWORD }}
        run: |
          sshpass -e scp -r -P 22 -o StrictHostKeyChecking=no \
            ./editor-build/* \
            ${{ secrets.SFTPUSER }}@${{ secrets.SFTPHOST }}:${{ env.EDITOR_DIRECTORY }}/
      - name: Download landing
        uses: actions/download-artifact@v4
        with:
          name: landing
          path: ./landing-build
      - name: Copy documentation files to landing
        run: |
          cp ./repo/llms.txt ./landing-build/
          cp ./repo/llms-full.txt ./landing-build/
          cp -r ./repo/docs ./landing-build/docs
      - name: Organize tutorial data for guides
        run: |
          mkdir -p ./landing-build/guides/two_trees
          mkdir -p ./landing-build/guides/grass_shrub_fire
          cp ./tutorial-data-temp/temperatureTulare.jshd ./landing-build/guides/two_trees/
          cp ./tutorial-data-temp/precipitationTulare.jshd ./landing-build/guides/two_trees/
          cp ./tutorial-data-temp/precipitation_geotiff.jshd ./landing-build/guides/grass_shrub_fire/precipitation.jshd
      - name: Remove publicsans directory before upload
        run: |
          if [ -d "./landing-build/publicsans" ]; then
            rm -rf ./landing-build/publicsans
            echo "Removed publicsans directory from landing-build"
          fi
      - name: Upload landing via SCP
        env:
          SSHPASS: ${{ secrets.SFTPPASSWORD }}
        run: |
          sshpass -e scp -r -P 22 -o StrictHostKeyChecking=no \
            ./landing-build/* \
            ${{ secrets.SFTPUSER }}@${{ secrets.SFTPHOST }}:${{ env.LANDING_DIRECTORY }}/
  deployCloud:
    name: Deploy to Cloud
    environment: Deploy
    runs-on: ubuntu-latest
    needs: [buildWeb]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    steps:
      - name: Set environment variables based on branch
        run: |
          if [[ $GITHUB_REF == refs/heads/main ]]; then
            echo "SERVICE_NAME=josh-executor-prod" >> $GITHUB_ENV
            echo "DOCKERFILE=Dockerfile.prod" >> $GITHUB_ENV
            echo "Deploying to Production environment"
          else
            echo "SERVICE_NAME=josh-executor-dev" >> $GITHUB_ENV
            echo "DOCKERFILE=Dockerfile.dev" >> $GITHUB_ENV
            echo "Deploying to Development environment"
          fi
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      - name: Download fatJar artifact
        uses: actions/download-artifact@v4
        with:
          name: fullJar
          path: ./cloud-img
      - name: Configure Docker
        run: gcloud auth configure-docker us-west1-docker.pkg.dev
      - name: Build and Push Docker image
        run: |
          # Build from the directory containing the Dockerfile
          docker build -t us-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/docker-repo/${{ env.SERVICE_NAME }}:${{ github.sha }} -f cloud-img/${{ env.DOCKERFILE }} cloud-img
          docker push us-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/docker-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --region=${{ secrets.REGION }} \
            --image=us-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/docker-repo/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --memory=16Gi \
            --cpu=6 \
            --min-instances=0 \
            --max-instances=100 \
            --port=8085 \
            --allow-unauthenticated \
            --set-secrets="JOSH_API_KEYS=${{ secrets.SECRET_NAME }}" \
            --use-http2 \
            --concurrency=1 \
            --timeout=3600s
